<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Q&A - IoT Health Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"/>
  <script defer src="{{ url_for('static', filename='js/scripts.js') }}"></script>
  <style>
    .msg{max-width:80%; padding:.75rem 1rem; border-radius:1rem; margin:.25rem 0;}
    .user{background:#1f2937; color:white; margin-left:auto;}
    .bot{background:white; color:#111827; border:1px solid #e5e7eb;}
    code, pre{white-space:pre-wrap; word-break:break-word;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  </style>
</head>
<body class="bg-gray-100">

  <!-- Menu Toggle Button -->
  <button id="toggleSidebar" class="text-white fixed top-2 left-2 z-30 bg-opal-dark rounded p-2">
    <span>☰</span>
  </button>

  <!-- Sidebar -->
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-40 w-56 bg-gray-800 text-white p-4
           transform -translate-x-full transition-transform duration-200
           md:translate-x-0 overflow-y-auto pt-16">
    <nav class="flex flex-col space-y-2 px-4">
      <a href="/" class="block hover:bg-gray-700 p-2 rounded">Home</a>
      <a href="/temperature" class="block hover:bg-gray-700 p-2 rounded">Temperature</a>
      <a href="/spo2" class="block hover:bg-gray-700 p-2 rounded">SpO₂</a>
      <a href="/ecg" class="block hover:bg-gray-700 p-2 rounded">ECG</a>
      <a href="/qa" class="block bg-opal-light hover:bg-gray-700 p-2 rounded">AI MediTaker </a>
    </nav>
  </aside>

  <!-- Main -->
  <div id="main" class="md:ml-56 pl-16 p-6">
    <!-- HERO (soft blue) -->
    <div class="mb-4 rounded-xl bg-blue-100 text-blue-900 border border-blue-200 shadow-sm">
      <div class="p-5 md:p-6">
        <h1 class="text-2xl md:text-3xl font-extrabold leading-tight">
          Ask <span class="underline decoration-blue-400">MediTaker</span> — your on-device medical caretaker.
        </h1>
        <p class="mt-2">Ρώτησε για <strong>Temperature</strong> &amp; <strong>SpO₂</strong>. Το μοντέλο βλέπει μόνο τα αποκρυπτογραφημένα που ήδη σερβίρει το app.</p>
      </div>
    </div>

    <!-- Bilingual safety notices (collapsible; GR & EN) -->
    <section id="notices" class="mb-6 border border-blue-200 rounded-lg bg-blue-50 text-blue-900">
      <button id="noticesToggle" type="button" class="w-full flex items-center justify-between p-3 focus:outline-none cursor-pointer select-none" aria-expanded="true">
        <span class="font-semibold">Προειδοποιήσεις / Safety notices</span>
        <svg id="noticesChev" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 transition-transform transform rotate-90">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
      </button>
      <div id="noticesPanel" class="px-4 pb-4 pt-0">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-sm">
          <div>
            <div class="font-semibold mb-1">Ελληνικά</div>
            <ul class="list-disc pl-5 space-y-1">
              <li>Ο MediTaker είναι AI βοηθός ενημερωτικού χαρακτήρα· δεν αντικαθιστά ιατρό.</li>
              <li>Δεν παρέχει διάγνωση, θεραπεία ή εξατομικευμένες ιατρικές οδηγίες.</li>
              <li>Τα δεδομένα σου επεξεργάζονται <span class="font-semibold">τοπικά</span> στη συσκευή (on‑device).</li>
              <li>Σε επείγον περιστατικό καλέστε το <span class="font-semibold">112</span> ή το τοπικό σας κέντρο άμεσης βοήθειας.</li>
            </ul>
          </div>
          <div>
            <div class="font-semibold mb-1">English</div>
            <ul class="list-disc pl-5 space-y-1">
              <li>MediTaker is an informational AI assistant; it does not replace a clinician.</li>
              <li>It does not provide diagnosis, treatment, or personalized medical advice.</li>
              <li>Your data is processed <span class="font-semibold">on‑device</span> locally on this machine.</li>
              <li>In an emergency, call <span class="font-semibold">112</span> or your local emergency number.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Chat box -->
    <div id="chat" class="bg-gray-50 rounded-xl p-4 shadow-lg min-h-[50vh] flex flex-col"></div>

    <div class="mt-4 flex gap-2">
      <input id="q" class="flex-1 border rounded-lg p-3" placeholder="π.χ. latest 10 SpO2 readings, average temperature on 2025-05-20"/>
      <button id="askBtn" class="px-4 py-2 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 transition">Ask</button>
    </div>
  </div>

  <script>
    // --- Chat essentials (UNCHANGED logic) ---
    const chat = document.getElementById('chat');
    const q = document.getElementById('q');
    const askBtn = document.getElementById('askBtn');

    function addMsg(text, who='bot', html=false){
      const div = document.createElement('div');
      div.className = `msg ${who==='user'?'user':'bot'}`;
      if(html){ div.innerHTML = text; } else { div.textContent = text; }
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function renderTable(cols, rows, maxRows=10){
      if(!rows || !rows.length) return "<div class='text-gray-500'>Result: (no rows)</div>";
      let ths = cols.map(c=>`<th class="px-2 py-1 border-b mono text-xs">${c}</th>`).join('');
      let trs = rows.slice(0,maxRows).map(r=>{
        const tds = r.map(x => `<td class="px-2 py-1 border-b mono text-xs">${x===null?'—':x}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      return `<div class="overflow-auto border rounded-lg">
        <table class="w-full text-left">
          <thead><tr>${ths}</tr></thead>
          <tbody>${trs}</tbody>
        </table>
      </div>`;
    }

    // --- Ask button visual states (only UI; logic identical) ---
    const BTN_PRIMARY = "px-4 py-2 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 transition";
    const BTN_WAITING = "px-4 py-2 rounded-lg font-semibold text-gray-800 bg-white border border-gray-300 cursor-wait transition";
    function setAskBusy(busy){
      if(busy){
        askBtn.disabled = true;
        askBtn.className = BTN_WAITING;
        askBtn.textContent = 'Asking…';
      }else{
        askBtn.disabled = false;
        askBtn.className = BTN_PRIMARY;
        askBtn.textContent = 'Ask';
      }
    }

    async function ask(){
      const question = q.value.trim();
      if(!question) return;
      addMsg(question, 'user');
      q.value = ''; q.focus();
      setAskBusy(true);

      try{
        const res = await fetch('/api/qa', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({question})
        });
        const data = await res.json();

        if(!res.ok){
          addMsg(`Error: ${data.error || 'Unknown error'}`);
          if(data.sql){ addMsg("Generated SQL (unsafe / error):\n"+data.sql); }
          return;
        }

        const answer = data.nl || "(no natural-language summary)";
        const tableHtml = renderTable(data.cols || [], data.rows || []);
        const details = `
          <div class="mt-2 p-3 bg-gray-100 rounded-lg">
            <div class="text-sm text-gray-700 font-semibold mb-1">SQL</div>
            <pre class="mono text-xs whitespace-pre-wrap">${data.sql || ''}</pre>
            <div class="text-sm text-gray-700 font-semibold mt-3 mb-1">Preview</div>
            ${tableHtml}
            <div class="text-xs text-gray-500 mt-2">Latency: ${data.latency_ms ?? '—'} ms</div>
          </div>`;
        addMsg(`<div><div>${answer}</div>${details}</div>`, 'bot', true);

      }catch(e){
        addMsg(`Network error: ${e}`);
      }finally{
        setAskBusy(false);
      }
    }

    askBtn.addEventListener('click', ask);
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(); }});

    // --- Notices accordion (pure UI) ---
    const NOTICES_KEY = 'meditaker_notices_collapsed';
    const nToggle = document.getElementById('noticesToggle');
    const nPanel  = document.getElementById('noticesPanel');
    const nChev   = document.getElementById('noticesChev');

    function setCollapsed(collapsed){
      if(!nPanel || !nChev || !nToggle) return;
      nPanel.classList.toggle('hidden', collapsed);
      nChev.classList.toggle('rotate-90', !collapsed); // down when open
      nToggle.setAttribute('aria-expanded', (!collapsed).toString());
    }

    let collapsed = localStorage.getItem(NOTICES_KEY) === '1';
    setCollapsed(collapsed);

    nToggle?.addEventListener('click', ()=>{
      collapsed = !collapsed;
      localStorage.setItem(NOTICES_KEY, collapsed ? '1':'0');
      setCollapsed(collapsed);
    });
  </script>
</body>
</html>




